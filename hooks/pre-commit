#!/bin/bash

# Pre-commit hook to run linting, formatting, and tests before allowing commits
# This ensures code quality and all tests pass before any commit is made

# Change to the repository root directory
cd "$(git rev-parse --show-toplevel)"

# Check if ruff is installed
if ! command -v ruff &> /dev/null; then
    echo "‚ö†Ô∏è  Warning: ruff is not installed. Skipping linting and formatting."
    echo "   Install with: uv pip install ruff"
else
    echo "üîç Running ruff linter..."

    # Run ruff check with auto-fix
    ruff check --fix .
    ruff_check_exit=$?

    if [ $ruff_check_exit -ne 0 ]; then
        echo ""
        echo "‚ùå Ruff linting failed! Commit aborted."
        echo "Please fix the linting errors before committing."
        exit 1
    fi

    echo "‚ú® Formatting code with ruff..."

    # Run ruff format
    ruff format .
    ruff_format_exit=$?

    if [ $ruff_format_exit -ne 0 ]; then
        echo ""
        echo "‚ùå Ruff formatting failed! Commit aborted."
        exit 1
    fi

    # Stage any changes made by ruff
    git add -u

    echo "‚úÖ Linting and formatting passed!"
fi

echo ""
echo "üß™ Running tests..."

# Run the test suite using the project's test runner
python run_tests.py

# Capture the exit code
test_exit_code=$?

# If tests failed, prevent the commit
if [ $test_exit_code -ne 0 ]; then
    echo ""
    echo "‚ùå Tests failed! Commit aborted."
    echo "Please fix the failing tests before committing."
    exit 1
fi

echo ""
echo "‚úÖ All checks passed! Proceeding with commit..."
exit 0